<!DOCTYPE html>
<html ng-app="inventoryApp">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System - API Version</title>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            padding: 20px;
        }
        
        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            color: #667eea;
            margin: 0;
            font-weight: bold;
        }
        
        .connection-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            margin-left: 15px;
        }
        
        .status-connected {
            background: #4CAF50;
            color: white;
        }
        
        .status-disconnected {
            background: #F44336;
            color: white;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .product-table {
            margin-top: 20px;
        }
        
        .btn-custom {
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 500;
        }
        
        .badge-stock {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .badge-in-stock {
            background: #4CAF50;
            color: white;
        }
        
        .badge-low-stock {
            background: #FF9800;
            color: white;
        }
        
        .badge-out-stock {
            background: #F44336;
            color: white;
        }
        
        .modal-content {
            border-radius: 15px;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .duplicate-warning {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .duplicate-info {
            color: #ff9800;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .input-error {
            border-color: #dc3545 !important;
        }
        
        .input-warning {
            border-color: #ff9800 !important;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert-custom {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body ng-controller="InventoryController">
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1>
                        <i class="fas fa-boxes"></i> Inventory Management System
                        <span class="connection-status" ng-class="{'status-connected': apiConnected, 'status-disconnected': !apiConnected}">
                            <i class="fas" ng-class="{'fa-check-circle': apiConnected, 'fa-times-circle': !apiConnected}"></i>
                            {{apiConnected ? 'API Connected' : 'API Disconnected'}}
                        </span>
                    </h1>
                    <p class="text-muted mb-0">Manage your products efficiently - API Version</p>
                </div>
                <button class="btn btn-primary btn-custom" ng-click="openAddModal()" ng-disabled="!apiConnected">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>
        </div>
        
        <!-- Connection Alert -->
        <div class="alert alert-danger alert-custom" ng-if="!apiConnected">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Backend Not Connected!</strong> 
            Make sure the backend server is running on http://localhost:3000
            <button class="btn btn-sm btn-outline-danger ms-3" ng-click="checkConnection()">
                <i class="fas fa-sync"></i> Retry Connection
            </button>
        </div>
        
        <!-- Loading -->
        <div class="loading" ng-if="loading">
            <div class="spinner"></div>
            <p class="mt-3">Loading products...</p>
        </div>
        
        <!-- Stats -->
        <div class="stats-row" ng-if="!loading">
            <div class="stat-card">
                <div class="stat-icon text-primary">
                    <i class="fas fa-box"></i>
                </div>
                <div class="stat-value">{{products.length}}</div>
                <div class="stat-label">Total Products</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon text-success">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="stat-value">${{getTotalValue()}}</div>
                <div class="stat-label">Total Value</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon text-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stat-value">{{getLowStockCount()}}</div>
                <div class="stat-label">Low Stock Items</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon text-info">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="stat-value">{{getCategories().length}}</div>
                <div class="stat-label">Categories</div>
            </div>
        </div>
        
        <!-- Products Table -->
        <div class="content-card" ng-if="!loading">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="d-inline"><i class="fas fa-list"></i> Products ({{getFilteredProducts().length}})</h3>
                    <span class="badge bg-info ms-2" ng-if="filters.searchText">
                        <i class="fas fa-search"></i> Searching: "{{filters.searchText}}"
                    </span>
                    <span class="badge bg-primary ms-2" ng-if="filters.category">
                        <i class="fas fa-filter"></i> {{filters.category}}
                    </span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success btn-custom" ng-click="exportToExcel()" title="Export to Excel">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button class="btn btn-outline-primary btn-custom" ng-click="showAdvancedFilters = !showAdvancedFilters" title="Advanced Filters">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                    <input type="text" 
                           class="form-control" 
                           placeholder="Search products..." 
                           ng-model="filters.searchText"
                           style="width: 300px;">
                    <select class="form-select" 
                            ng-model="filters.category"
                            style="width: 200px;">
                        <option value="">All Categories</option>
                        <option ng-repeat="cat in getCategories() track by $index" value="{{cat}}">{{cat}}</option>
                    </select>
                </div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div class="card mb-3" ng-if="showAdvancedFilters" style="border: 1px solid #667eea;">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-sliders-h"></i> Advanced Filters</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Stock Status</label>
                            <select class="form-select" ng-model="filters.stockStatus">
                                <option value="">All Status</option>
                                <option value="in_stock">In Stock</option>
                                <option value="low_stock">Low Stock</option>
                                <option value="out_of_stock">Out of Stock</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Min Price</label>
                            <input type="number" class="form-control" ng-model="filters.minPrice" placeholder="0.00">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Max Price</label>
                            <input type="number" class="form-control" ng-model="filters.maxPrice" placeholder="9999.99">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sort By</label>
                            <select class="form-select" ng-model="filters.sortBy">
                                <option value="name">Name (A-Z)</option>
                                <option value="-name">Name (Z-A)</option>
                                <option value="price">Price (Low to High)</option>
                                <option value="-price">Price (High to Low)</option>
                                <option value="quantity">Quantity (Low to High)</option>
                                <option value="-quantity">Quantity (High to Low)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-secondary" ng-click="clearFilters()">
                            <i class="fas fa-times"></i> Clear Filters
                        </button>
                        <span class="ms-3 text-muted">
                            Showing {{getFilteredProducts().length}} of {{products.length}} products
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive product-table">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>SKU</th>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="product in getFilteredProducts() track by product._id">
                            <td><strong>{{product.sku}}</strong></td>
                            <td>{{product.name}}</td>
                            <td><span class="badge bg-secondary">{{getCategoryName(product.category)}}</span></td>
                            <td>${{product.price}}</td>
                            <td>{{product.quantity}}</td>
                            <td>
                                <span class="badge-stock" ng-class="{
                                    'badge-in-stock': product.quantity > product.minQuantity,
                                    'badge-low-stock': product.quantity <= product.minQuantity && product.quantity > 0,
                                    'badge-out-stock': product.quantity === 0
                                }">
                                    {{getStockStatus(product)}}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" ng-click="editProduct(product)" ng-disabled="!apiConnected">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" ng-click="deleteProduct(product)" ng-disabled="!apiConnected">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <div ng-if="getFilteredProducts().length === 0" class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No products found</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add/Edit Product Modal -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{modalTitle}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form>
                        <div class="mb-3">
                            <label class="form-label">SKU *</label>
                            <input type="text" class="form-control" 
                                   ng-model="currentProduct.sku" 
                                   ng-class="{'input-error': isDuplicateSKU(currentProduct.sku, currentProduct._id)}"
                                   required>
                            <div class="duplicate-warning" ng-if="isDuplicateSKU(currentProduct.sku, currentProduct._id)">
                                <i class="fas fa-exclamation-circle"></i> This SKU already exists! Please use a unique SKU.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" 
                                   ng-model="currentProduct.name" 
                                   ng-class="{'input-warning': isDuplicateName(currentProduct.name, currentProduct._id)}"
                                   required>
                            <div class="duplicate-info" ng-if="isDuplicateName(currentProduct.name, currentProduct._id)">
                                <i class="fas fa-info-circle"></i> A product with similar name already exists.
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category *</label>
                            <input type="text" class="form-control" ng-model="currentProduct.category" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price *</label>
                                <input type="number" class="form-control" ng-model="currentProduct.price" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cost</label>
                                <input type="number" class="form-control" ng-model="currentProduct.cost">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Quantity *</label>
                                <input type="number" class="form-control" ng-model="currentProduct.quantity" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Min Quantity</label>
                                <input type="number" class="form-control" ng-model="currentProduct.minQuantity">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" ng-model="currentProduct.description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" ng-click="saveProduct()" ng-disabled="saving">
                        <span ng-if="!saving">Save Product</span>
                        <span ng-if="saving"><i class="fas fa-spinner fa-spin"></i> Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        var app = angular.module('inventoryApp', []);
        
        app.controller('InventoryController', function($scope, $http, $timeout) {
            $scope.API_URL = 'http://localhost:3000/api';
            $scope.products = [];
            
            // Wrap filters in an object to avoid scope issues
            $scope.filters = {
                searchText: '',
                category: '',
                stockStatus: '',
                minPrice: null,
                maxPrice: null,
                sortBy: 'name'
            };
            
            $scope.showAdvancedFilters = false;
            $scope.currentProduct = {};
            $scope.modalTitle = 'Add Product';
            $scope.editMode = false;
            $scope.apiConnected = false;
            $scope.loading = true;
            $scope.saving = false;
            
            // Check API connection
            $scope.checkConnection = function() {
                $http.get('http://localhost:3000/health')
                    .then(function(response) {
                        $scope.apiConnected = true;
                        $scope.loadProducts();
                    })
                    .catch(function(error) {
                        $scope.apiConnected = false;
                        $scope.loading = false;
                        console.error('API Connection Error:', error);
                    });
            };
            
            // Load products from API
            $scope.loadProducts = function() {
                $scope.loading = true;
                console.log('Loading products from API...');
                $http.get($scope.API_URL + '/products')
                    .then(function(response) {
                        $scope.products = response.data.data || [];
                        console.log('Products loaded:', $scope.products.length);
                        console.log('First product:', $scope.products[0]);
                        $scope.loading = false;
                    })
                    .catch(function(error) {
                        console.error('Error loading products:', error);
                        $scope.loading = false;
                        alert('Error loading products: ' + (error.data?.message || error.statusText));
                    });
            };
            
            // Get filtered products
            $scope.getFilteredProducts = function() {
                if (!$scope.products || $scope.products.length === 0) {
                    console.log('No products to filter');
                    return [];
                }
                
                console.log('Filtering products. Search:', $scope.filters.searchText, 'Category:', $scope.filters.category);
                
                var filtered = $scope.products.filter(function(product) {
                    // Search filter
                    var matchesSearch = true;
                    if ($scope.filters.searchText && $scope.filters.searchText.trim() !== '') {
                        var searchLower = $scope.filters.searchText.toLowerCase();
                        var nameMatch = product.name && product.name.toLowerCase().includes(searchLower);
                        var skuMatch = product.sku && product.sku.toLowerCase().includes(searchLower);
                        matchesSearch = nameMatch || skuMatch;
                    }
                    
                    // Category filter
                    var matchesCategory = true;
                    if ($scope.filters.category && $scope.filters.category !== '') {
                        var categoryName = $scope.getCategoryName(product.category);
                        matchesCategory = categoryName === $scope.filters.category;
                    }
                    
                    // Stock status filter
                    var matchesStockStatus = true;
                    if ($scope.filters.stockStatus && $scope.filters.stockStatus !== '') {
                        var status = $scope.getStockStatus(product);
                        if ($scope.filters.stockStatus === 'in_stock') {
                            matchesStockStatus = status === 'In Stock';
                        } else if ($scope.filters.stockStatus === 'low_stock') {
                            matchesStockStatus = status === 'Low Stock';
                        } else if ($scope.filters.stockStatus === 'out_of_stock') {
                            matchesStockStatus = status === 'Out of Stock';
                        }
                    }
                    
                    // Price range filter
                    var matchesPrice = true;
                    if ($scope.filters.minPrice !== null && $scope.filters.minPrice !== '' && $scope.filters.minPrice !== undefined) {
                        matchesPrice = matchesPrice && product.price >= parseFloat($scope.filters.minPrice);
                    }
                    if ($scope.filters.maxPrice !== null && $scope.filters.maxPrice !== '' && $scope.filters.maxPrice !== undefined) {
                        matchesPrice = matchesPrice && product.price <= parseFloat($scope.filters.maxPrice);
                    }
                    
                    return matchesSearch && matchesCategory && matchesStockStatus && matchesPrice;
                });
                
                // Apply sorting
                if ($scope.filters.sortBy) {
                    var sortField = $scope.filters.sortBy.replace('-', '');
                    var sortOrder = $scope.filters.sortBy.startsWith('-') ? -1 : 1;
                    
                    filtered.sort(function(a, b) {
                        var aVal = a[sortField];
                        var bVal = b[sortField];
                        
                        // Handle undefined values
                        if (aVal === undefined) aVal = 0;
                        if (bVal === undefined) bVal = 0;
                        
                        // Handle string comparison
                        if (typeof aVal === 'string' && typeof bVal === 'string') {
                            aVal = aVal.toLowerCase();
                            bVal = bVal.toLowerCase();
                        }
                        
                        // Handle numeric comparison
                        if (typeof aVal === 'number' && typeof bVal === 'number') {
                            return (aVal - bVal) * sortOrder;
                        }
                        
                        // String comparison
                        if (aVal < bVal) return -1 * sortOrder;
                        if (aVal > bVal) return 1 * sortOrder;
                        return 0;
                    });
                }
                
                console.log('Filtered products count:', filtered.length);
                return filtered;
            };
            
            // Clear filters
            $scope.clearFilters = function() {
                $scope.filters.searchText = '';
                $scope.filters.category = '';
                $scope.filters.stockStatus = '';
                $scope.filters.minPrice = null;
                $scope.filters.maxPrice = null;
                $scope.filters.sortBy = 'name';
            };
            
            // Get total value
            $scope.getTotalValue = function() {
                return $scope.products.reduce(function(sum, product) {
                    return sum + (product.price * product.quantity);
                }, 0).toFixed(2);
            };
            
            // Get low stock count
            $scope.getLowStockCount = function() {
                return $scope.products.filter(function(product) {
                    return product.quantity <= product.minQuantity && product.quantity > 0;
                }).length;
            };
            
            // Get categories
            $scope.getCategories = function() {
                var categories = $scope.products.map(function(p) { 
                    return $scope.getCategoryName(p.category); 
                });
                return [...new Set(categories)];
            };
            
            // Get category name (handle both string and object)
            $scope.getCategoryName = function(category) {
                if (!category) return 'Uncategorized';
                if (typeof category === 'string') return category;
                if (category.name) return category.name;
                if (category._id) return category._id;
                return 'Unknown';
            };
            
            // Get stock status
            $scope.getStockStatus = function(product) {
                if (product.quantity === 0) return 'Out of Stock';
                if (product.quantity <= product.minQuantity) return 'Low Stock';
                return 'In Stock';
            };
            
            // Check for duplicate SKU
            $scope.isDuplicateSKU = function(sku, currentId) {
                if (!sku) return false;
                return $scope.products.some(function(p) {
                    return p.sku && p.sku.toLowerCase() === sku.toLowerCase() && p._id !== currentId;
                });
            };
            
            // Check for duplicate name
            $scope.isDuplicateName = function(name, currentId) {
                if (!name) return false;
                return $scope.products.some(function(p) {
                    return p.name && p.name.toLowerCase() === name.toLowerCase() && p._id !== currentId;
                });
            };
            
            // Open add modal
            $scope.openAddModal = function() {
                $scope.currentProduct = {
                    sku: '',
                    name: '',
                    category: '',
                    price: 0,
                    cost: 0,
                    quantity: 0,
                    minQuantity: 10,
                    description: ''
                };
                $scope.modalTitle = 'Add Product';
                $scope.editMode = false;
                var modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
            };
            
            // Edit product
            $scope.editProduct = function(product) {
                $scope.currentProduct = angular.copy(product);
                // Extract category name if it's an object
                if ($scope.currentProduct.category && typeof $scope.currentProduct.category === 'object') {
                    $scope.currentProduct.category = $scope.currentProduct.category.name || $scope.currentProduct.category._id;
                }
                $scope.modalTitle = 'Edit Product';
                $scope.editMode = true;
                var modal = new bootstrap.Modal(document.getElementById('productModal'));
                modal.show();
            };
            
            // Save product
            $scope.saveProduct = function() {
                // Trim whitespace
                if ($scope.currentProduct.sku) {
                    $scope.currentProduct.sku = $scope.currentProduct.sku.trim();
                }
                if ($scope.currentProduct.name) {
                    $scope.currentProduct.name = $scope.currentProduct.name.trim();
                }
                
                // Validation
                if (!$scope.currentProduct.sku || !$scope.currentProduct.name || !$scope.currentProduct.category) {
                    alert('⚠️ SKU, Product Name, and Category are required!');
                    return;
                }
                
                // Check for duplicate SKU
                if ($scope.isDuplicateSKU($scope.currentProduct.sku, $scope.currentProduct._id)) {
                    alert('⚠️ Duplicate SKU!\n\nA product with SKU "' + $scope.currentProduct.sku + '" already exists.\nPlease use a unique SKU.');
                    return;
                }
                
                $scope.saving = true;
                
                var request;
                if ($scope.editMode) {
                    request = $http.put($scope.API_URL + '/products/' + $scope.currentProduct._id, $scope.currentProduct);
                } else {
                    request = $http.post($scope.API_URL + '/products', $scope.currentProduct);
                }
                
                request.then(function(response) {
                    $scope.saving = false;
                    var modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
                    modal.hide();
                    $scope.loadProducts();
                    alert('✅ Product saved successfully!');
                })
                .catch(function(error) {
                    $scope.saving = false;
                    console.error('Error saving product:', error);
                    alert('❌ Error: ' + (error.data?.message || error.statusText));
                });
            };
            
            // Delete product
            $scope.deleteProduct = function(product) {
                if (confirm('Are you sure you want to delete ' + product.name + '?')) {
                    $http.delete($scope.API_URL + '/products/' + product._id)
                        .then(function(response) {
                            $scope.loadProducts();
                            alert('✅ Product deleted successfully!');
                        })
                        .catch(function(error) {
                            console.error('Error deleting product:', error);
                            alert('❌ Error: ' + (error.data?.message || error.statusText));
                        });
                }
            };
            
            // Export to Excel
            $scope.exportToExcel = function() {
                try {
                    // Get filtered products
                    var productsToExport = $scope.getFilteredProducts();
                    
                    if (productsToExport.length === 0) {
                        alert('⚠️ No products to export!');
                        return;
                    }
                    
                    // Prepare data for Excel
                    var excelData = productsToExport.map(function(product) {
                        return {
                            'SKU': product.sku,
                            'Product Name': product.name,
                            'Category': $scope.getCategoryName(product.category),
                            'Price': product.price,
                            'Cost': product.cost || 0,
                            'Quantity': product.quantity,
                            'Min Quantity': product.minQuantity,
                            'Stock Status': $scope.getStockStatus(product),
                            'Total Value': (product.price * product.quantity).toFixed(2),
                            'Profit Margin': product.cost ? (((product.price - product.cost) / product.cost * 100).toFixed(2) + '%') : 'N/A',
                            'Description': product.description || '',
                            'Unit': product.unit || 'piece',
                            'Status': product.status || 'active'
                        };
                    });
                    
                    // Create workbook and worksheet
                    var wb = XLSX.utils.book_new();
                    var ws = XLSX.utils.json_to_sheet(excelData);
                    
                    // Set column widths
                    ws['!cols'] = [
                        {wch: 15}, // SKU
                        {wch: 30}, // Product Name
                        {wch: 15}, // Category
                        {wch: 10}, // Price
                        {wch: 10}, // Cost
                        {wch: 10}, // Quantity
                        {wch: 12}, // Min Quantity
                        {wch: 15}, // Stock Status
                        {wch: 12}, // Total Value
                        {wch: 15}, // Profit Margin
                        {wch: 40}, // Description
                        {wch: 10}, // Unit
                        {wch: 10}  // Status
                    ];
                    
                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'Products');
                    
                    // Add summary sheet
                    var summaryData = [
                        {Metric: 'Total Products', Value: productsToExport.length},
                        {Metric: 'Total Inventory Value', Value: '$' + $scope.getTotalValue()},
                        {Metric: 'Low Stock Items', Value: $scope.getLowStockCount()},
                        {Metric: 'Out of Stock Items', Value: productsToExport.filter(function(p) { return p.quantity === 0; }).length},
                        {Metric: 'Categories', Value: $scope.getCategories().length},
                        {Metric: 'Export Date', Value: new Date().toLocaleString()}
                    ];
                    
                    var wsSummary = XLSX.utils.json_to_sheet(summaryData);
                    wsSummary['!cols'] = [{wch: 25}, {wch: 20}];
                    XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');
                    
                    // Generate filename with timestamp
                    var filename = 'Inventory_Export_' + new Date().toISOString().slice(0,10) + '.xlsx';
                    
                    // Save file
                    XLSX.writeFile(wb, filename);
                    
                    alert('✅ Excel file exported successfully!\n\nFile: ' + filename + '\nProducts: ' + productsToExport.length);
                } catch (error) {
                    console.error('Export error:', error);
                    alert('❌ Error exporting to Excel: ' + error.message);
                }
            };
            
            // Initialize
            $scope.checkConnection();
        });
    </script>
</body>
</html>
